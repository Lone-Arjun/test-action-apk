<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BuilderEngine</title>
    <link rel="icon" type="image/png" href="assets/logo.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #1a1a1a;
            color: white;
            overflow: hidden;
        }

        /* WebView Container */
        #webview-container {
            width: 100%;
            height: 100vh;
            position: relative;
        }

        #main-iframe {
            width: 100%;
            height: 100%;
            border: none;
            display: block;
        }

        /* Offline/Error Pages */
        .page-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .page-overlay.show {
            display: flex;
        }

        .content {
            text-align: center;
            padding: 2rem;
            max-width: 400px;
        }

        .logo {
            width: 80px;
            height: 80px;
            margin-bottom: 1.5rem;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        h2 {
            font-size: 1.8rem;
            margin-bottom: 1rem;
            font-weight: 600;
        }

        p {
            font-size: 1rem;
            margin-bottom: 2rem;
            opacity: 0.9;
            line-height: 1.5;
        }

        .retry-button {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .retry-button:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-2px);
        }

        .retry-button:active {
            transform: translateY(0);
        }

        /* Offline specific styling */
        #offline-page {
            background: linear-gradient(135deg, #46078e 0%, #0a0481 100%);
        }

        /* Error specific styling */
        #error-page {
            background: linear-gradient(135deg, #fc466b 0%, #3f5efb 100%);
        }

        /* Connection status indicator */
        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 999;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            opacity: 0;
            pointer-events: none;
        }

        .connection-status.offline {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #ef4444;
            opacity: 1;
            pointer-events: auto;
        }
    </style>
</head>
<body>
    <!-- Connection Status Indicator -->
    <div id="connection-status" class="connection-status">
        <span>Offline</span>
    </div>

    <!-- Offline Page -->
    <div id="offline-page" class="page-overlay">
        <div class="content">
            <img src="assets/logo.png" alt="BuilderEngine" class="logo">
            <h2>You're Offline</h2>
            <p>Please check your internet connection and try again.</p>
            <button id="retry-btn" class="retry-button">Try Again</button>
        </div>
    </div>

    <!-- Error Page -->
    <div id="error-page" class="page-overlay">
        <div class="content">
            <img src="assets/logo.png" alt="BuilderEngine" class="logo">
            <h2>Something went wrong</h2>
            <p>Unable to load BuilderEngine. Please try again.</p>
            <button id="error-retry-btn" class="retry-button">Retry</button>
        </div>
    </div>

    <!-- Main WebView Container -->
    <div id="webview-container">
        <iframe id="main-iframe" src="about:blank" frameborder="0"></iframe>
    </div>

    <script>
        class BuilderEngineApp {
            constructor() {
                this.targetUrl = 'https://builderengine.vercel.app/login';
                this.iframe = null;
                this.isOnline = true;
                this.iframeLoadTimeout = null;
                this.connectionCheckInterval = null;
                this.retryAttempts = 0;
                this.maxRetryAttempts = 3;
                this.init();
            }

            async init() {
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', () => this.setup());
                } else {
                    this.setup();
                }
            }

            setup() {
                this.setupElements();
                this.setupEventListeners();
                this.startConnectionMonitoring();
                this.checkConnectionAndLoad();
            }

            setupElements() {
                this.iframe = document.getElementById('main-iframe');
                this.webviewContainer = document.getElementById('webview-container');
                this.offlinePage = document.getElementById('offline-page');
                this.errorPage = document.getElementById('error-page');
                this.retryBtn = document.getElementById('retry-btn');
                this.errorRetryBtn = document.getElementById('error-retry-btn');
                this.connectionStatus = document.getElementById('connection-status');
            }

            setupEventListeners() {
                // Retry buttons
                this.retryBtn.addEventListener('click', () => this.handleRetry());
                this.errorRetryBtn.addEventListener('click', () => this.handleRetry());

                // Network listeners
                window.addEventListener('online', () => this.handleNetworkChange(true));
                window.addEventListener('offline', () => this.handleNetworkChange(false));

                // Page visibility change
                document.addEventListener('visibilitychange', () => {
                    if (!document.hidden) {
                        this.checkConnectionAndLoad();
                    }
                });

                // Iframe load detection with better error handling
                this.iframe.addEventListener('load', () => {
                    // Use setTimeout to allow iframe to fully load
                    setTimeout(() => this.handleIframeLoad(), 100);
                });

                this.iframe.addEventListener('error', () => this.handleIframeError());
            }

            startConnectionMonitoring() {
                // Check connection every 5 seconds
                this.connectionCheckInterval = setInterval(() => {
                    this.checkRealConnection();
                }, 5000);

                // Initial connection check
                this.checkRealConnection();
            }

            async checkRealConnection() {
                try {
                    // Try to fetch a small resource to test actual connectivity
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 3000);

                    const response = await fetch('https://www.google.com/favicon.ico', {
                        method: 'HEAD',
                        mode: 'no-cors',
                        cache: 'no-cache',
                        signal: controller.signal
                    });

                    clearTimeout(timeoutId);
                    this.updateConnectionStatus(true);
                } catch (error) {
                    this.updateConnectionStatus(false);
                }
            }

            updateConnectionStatus(isOnline) {
                const wasOnline = this.isOnline;
                this.isOnline = isOnline;

                if (isOnline) {
                    this.connectionStatus.classList.remove('offline');
                } else {
                    this.connectionStatus.classList.add('offline');
                }

                // If connection status changed, handle it
                if (wasOnline !== isOnline) {
                    this.handleNetworkChange(isOnline);
                }
            }

            handleNetworkChange(isOnline) {
                console.log('Network status changed:', isOnline ? 'online' : 'offline');
                
                if (isOnline) {
                    // If we were showing offline page, retry loading
                    if (this.offlinePage.classList.contains('show')) {
                        this.handleRetry();
                    }
                } else {
                    // Show offline page immediately
                    this.showOfflinePage();
                }
            }

            async checkConnectionAndLoad() {
                // Check if we have internet connectivity
                if (!this.isOnline || !navigator.onLine) {
                    this.showOfflinePage();
                    return;
                }

                // If online, try to load the iframe
                this.showWebView();
                this.loadIframe();
            }

            loadIframe() {
                if (!this.isOnline) {
                    this.showOfflinePage();
                    return;
                }

                // Clear any existing timeout
                if (this.iframeLoadTimeout) {
                    clearTimeout(this.iframeLoadTimeout);
                }

                // Add cache buster and load the iframe
                const url = `${this.targetUrl}?_t=${Date.now()}&retry=${this.retryAttempts}`;
                console.log('Loading iframe:', url);
                this.iframe.src = url;

                // Set a timeout to detect load failures
                this.iframeLoadTimeout = setTimeout(() => {
                    console.log('Iframe load timeout');
                    this.handleLoadTimeout();
                }, 10000); // 10 second timeout
            }

            handleIframeLoad() {
                console.log('Iframe load event triggered');
                
                if (this.iframeLoadTimeout) {
                    clearTimeout(this.iframeLoadTimeout);
                    this.iframeLoadTimeout = null;
                }

                // Check if iframe actually loaded content
                try {
                    const iframeSrc = this.iframe.src;
                    
                    // If iframe src is about:blank or empty, it didn't load properly
                    if (!iframeSrc || iframeSrc === 'about:blank') {
                        console.log('Iframe src is blank, treating as error');
                        this.handleIframeError();
                        return;
                    }

                    // Check if we can detect the iframe content
                    const iframeWindow = this.iframe.contentWindow;
                    if (!iframeWindow) {
                        console.log('No iframe window, treating as error');
                        this.handleIframeError();
                        return;
                    }

                } catch (e) {
                    // Cross-origin restriction is expected, treat as successful load
                    console.log('Cross-origin iframe detected - assuming successful load');
                }

                console.log('Iframe loaded successfully');
                this.retryAttempts = 0; // Reset retry attempts on successful load
                this.hideAllOverlays();
            }

            handleLoadTimeout() {
                console.log('Load timeout - checking connection and showing appropriate page');
                
                if (!this.isOnline || !navigator.onLine) {
                    this.showOfflinePage();
                } else {
                    this.retryAttempts++;
                    if (this.retryAttempts >= this.maxRetryAttempts) {
                        this.showErrorPage();
                    } else {
                        // Auto-retry with exponential backoff
                        setTimeout(() => {
                            this.loadIframe();
                        }, 2000 * this.retryAttempts);
                    }
                }
            }

            handleIframeError() {
                console.log('Iframe error detected');
                
                if (this.iframeLoadTimeout) {
                    clearTimeout(this.iframeLoadTimeout);
                    this.iframeLoadTimeout = null;
                }

                // Check network status first
                if (!this.isOnline || !navigator.onLine) {
                    this.showOfflinePage();
                } else {
                    this.showErrorPage();
                }
            }

            showOfflinePage() {
                console.log('Showing offline page');
                this.iframe.src = 'about:blank';
                this.hideAllOverlays();
                this.offlinePage.classList.add('show');
            }

            showErrorPage() {
                console.log('Showing error page');
                this.hideAllOverlays();
                this.errorPage.classList.add('show');
            }

            showWebView() {
                console.log('Showing webview');
                this.hideAllOverlays();
            }

            hideAllOverlays() {
                this.offlinePage.classList.remove('show');
                this.errorPage.classList.remove('show');
            }

            handleRetry() {
                console.log('Retrying connection...');
                this.retryAttempts = 0; // Reset retry attempts
                this.hideAllOverlays();
                
                // Force a connection check before retrying
                this.checkRealConnection();
                
                setTimeout(() => {
                    this.checkConnectionAndLoad();
                }, 1000);
            }
        }

        // Initialize the app
        window.app = new BuilderEngineApp();
    </script>
</body>
</html>
